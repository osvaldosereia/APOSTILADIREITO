<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>direito.love ‚Äî In√≠cio</title>
  <meta name="theme-color" content="#0c4160" />

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <style>
    :root{
      --bg:#f6f7fb; --surface:#ffffff; --ink:#0f172a; --muted:#64748b; --border:#e5e7eb;
      --primary:#0c4160; --primary-2:#0e567c; --accent:#1aab6c;
      --radius:22px; --elev-1:0 8px 30px rgba(15,23,42,.08);
      --fs-h:clamp(22px,4vw,40px); --fs-b:clamp(14px,1.8vw,16px);
      --chip:#f3f4f6;
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0;
      background:
        radial-gradient(1200px 800px at 0% -20%, #eaf7f5 0%, transparent 60%),
        radial-gradient(800px 600px at 110% 10%, #f1f6fb 0%, transparent 55%),
        var(--bg);
      color:var(--ink);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      font-size:var(--fs-b);
    }
    a{ color:var(--primary); text-decoration:none }
    .wrap{ max-width:1100px; margin:0 auto; padding:22px 16px 140px } /* espa√ßo p/ barra flutuante */

    /* Header */
    .top{ display:flex; justify-content:space-between; align-items:center; margin-bottom:8px }
    .brand{ display:flex; align-items:center; gap:10px }
    .logo{ display:block; width:auto; height:32px }
    .right-icons{ display:flex; align-items:center; gap:10px }

    /* Tabs (In√≠cio / Arquivo) */
    .tabs{ display:flex; gap:8px; margin:8px 0 18px }
    .tab{ all:unset; border:1px solid var(--border); background:#fff; padding:8px 12px; border-radius:999px; cursor:pointer; font-weight:700 }
    .tab[aria-selected="true"]{ background:var(--primary); color:#fff; border-color:transparent }

    .card{ background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--elev-1); padding:22px }
    .title{ font-weight:800; font-size:var(--fs-h); line-height:1.05; margin:0 0 12px }

    /* Step 1 */
    .row{ display:grid; gap:12px; grid-template-columns:1fr auto }
    .field{
      width:100%; border:1px solid var(--border); background:#f4f7fb;
      border-radius:16px; padding:14px 16px; outline:none; color:var(--ink);
    }
    .field:focus{ border-color:#b9c6d1; box-shadow:0 0 0 3px rgba(14,86,124,.12) }
    .btn{ all:unset; display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 14px; border-radius:14px; font-weight:700; cursor:pointer }
    .btn-primary{ background:var(--primary); color:#fff }
    .btn-primary:hover{ background:var(--primary-2) }
    .btn-ghost{ border:1px solid var(--border); background:#fff; color:#0f172a }
    .btn-small{ padding:6px 10px; font-size:12px; border-radius:12px }
    .btn-disabled{ opacity:.5; cursor:not-allowed; pointer-events:none }

    /* ‚ÄúComo funciona‚Äù discreto */
    .helper{ margin-top:8px; display:flex; justify-content:flex-end }
    .helper .btn{ color:var(--muted) }

    /* Objetivos */
    .grid-obj{ display:grid; gap:14px; grid-template-columns:1fr }
    @media (min-width: 768px){
      .grid-obj{ grid-template-columns:1fr 1fr 1fr }
    }
    .obj{
      border:1px solid var(--border); border-radius:18px; background:#fff; padding:16px;
      transition:transform .1s ease, box-shadow .1s ease; cursor:pointer
    }
    .obj:hover{ transform:translateY(-2px); box-shadow:0 12px 28px rgba(15,23,42,.10) }
    .obj h3{ margin:0 0 10px; font-size:18px; display:flex; align-items:center; gap:10px }
    .obj img{ height:84px; width:auto; border-radius:14px }

    /* Chips IA */
    .chips{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px }
    .chip{
      all:unset; background:var(--chip); border:1px solid var(--border);
      padding:8px 10px; border-radius:999px; cursor:pointer; font-weight:700; min-height:40px;
    }
    .chip.primary{ background:var(--primary); color:#fff; border-color:transparent }

    /* Result container */
    .divider{ height:1px; background:var(--border); margin:18px 0 }

    /* Barra flutuante */
    .floatbar{
      position:fixed; left:16px; right:16px; bottom:16px; z-index:9998;
      display:flex; justify-content:flex-end; gap:8px; align-items:center; pointer-events:none;
    }
    .floatbar .inner{
      pointer-events:auto; display:flex; gap:8px; background:rgba(255,255,255,.92);
      border:1px solid var(--border); border-radius:14px; padding:8px 10px; box-shadow:var(--elev-1)
    }

    .toast{
      position:fixed; z-index:9999; right:16px; bottom:80px; background:#0e567c; color:#fff;
      padding:12px 16px; border-radius:12px; box-shadow:var(--elev-1); display:none; font-weight:700
    }

    /* Personagem/hero */
    .hero{
      display:flex; gap:16px; align-items:center; margin-top:12px; flex-wrap:wrap
    }
    .hero img{ width:110px; height:110px; border-radius:18px; object-fit:cover; }
    .hero small{ color:var(--muted) }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="top">
      <div class="brand">
        <img class="logo" src="./icons/logo-heart.png" alt="direito.love" />
      </div>
      <div class="right-icons">
        <a href="https://www.instagram.com/osvaldosereiajr/" target="_blank" rel="noopener" title="Instagram">
          <img src="./icons/instagram.png" alt="Instagram" style="height:24px;width:24px" />
        </a>
      </div>
    </header>

    <nav class="tabs" role="tablist" aria-label="Navega√ß√£o">
      <button class="tab" id="tab-inicio" aria-controls="panel-inicio" aria-selected="true">In√≠cio</button>
      <button class="tab" id="tab-arquivo" aria-controls="panel-arquivo" aria-selected="false">Arquivo</button>
    </nav>

    <!-- PAINEL: IN√çCIO -->
    <section id="panel-inicio" class="card" role="tabpanel" aria-labelledby="tab-inicio">
      <h1 class="title">Sobre o que vamos falar?</h1>

      <!-- Passo 1: tema + Avan√ßar -->
      <div class="row" id="step1">
        <input id="tema" class="field" type="text" placeholder="Ex.: Dano moral por negativa√ß√£o indevida" aria-label="Tema" />
        <button id="avancar" class="btn btn-primary" title="Avan√ßar para objetivos">Avan√ßar</button>
      </div>
      <div class="helper">
        <button id="como-btn" class="btn btn-ghost btn-small" title="Entenda o fluxo">
          <img src="./icons/info.png" alt="" style="height:14px;width:14px" />&nbsp;Como funciona
        </button>
      </div>

      <!-- Passo 2: objetivos (mostra s√≥ depois do avan√ßar) -->
      <div id="step2" style="display:none; margin-top:16px">
        <div class="grid-obj">
          <div class="obj" data-objetivo="aprender" tabindex="0" role="button" aria-label="Escolher objetivo APRENDER">
            <h3>APRENDER</h3>
            <img src="./icons/character-1.png" alt="Aluno animado" />
            <small class="muted">Explica√ß√£o did√°tica e personalizada</small>
            <div class="chips" data-chips="aprender" style="display:none"></div>
          </div>

          <div class="obj" data-objetivo="treinar" tabindex="0" role="button" aria-label="Escolher objetivo TREINAR">
            <h3>TREINAR</h3>
            <img src="./icons/character-2.png" alt="Aluno sorridente" />
            <small class="muted">10 quest√µes objetivas + gabarito no final</small>
            <div class="chips" data-chips="treinar" style="display:none"></div>
          </div>

          <div class="obj" data-objetivo="atualizar" tabindex="0" role="button" aria-label="Escolher objetivo ATUALIZAR">
            <h3>ATUALIZAR</h3>
            <img src="./icons/character-3.png" alt="Aluno acenando" />
            <small class="muted">Curadoria de 10+ not√≠cias reais e recentes</small>
            <div class="chips" data-chips="atualizar" style="display:none"></div>
          </div>
        </div>

        <div class="hero">
          <img id="hero-avatar" src="./icons/character-4.png" alt="Estudante" />
          <small>Um estudante diferente aparece a cada visita üòâ</small>
        </div>
      </div>

      <div class="divider"></div>
    </section>

    <!-- PAINEL: ARQUIVO -->
    <section id="panel-arquivo" class="card" role="tabpanel" aria-labelledby="tab-arquivo" hidden>
      <h2 class="title" style="font-size:26px">Arquivo ‚Äî por estrat√©gia</h2>
      <div id="book-grouped"></div>
    </section>
  </div>

  <!-- Barra flutuante -->
  <div class="floatbar" aria-label="A√ß√µes r√°pidas">
    <div class="inner">
      <a id="open-ia" class="btn btn-ghost btn-disabled" href="#" target="_blank" rel="noopener" aria-disabled="true">Abrir IA</a>
      <button id="reset" type="button" class="btn btn-primary">Nova pesquisa</button>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite">Copiado!</div>

  <!-- Modal Como Funciona -->
  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="mf-title" style="display:none">
    <div class="card" style="max-width:760px;margin:10vh auto">
      <h3 id="mf-title" style="margin:0 0 10px">Como funciona</h3>
      <ol style="margin:0;padding-left:18px;color:#0f172a">
        <li>Digite o <b>tema</b> e clique em <b>Avan√ßar</b>.</li>
        <li>Selecione um <b>objetivo</b>.</li>
        <li>Escolha uma <b>IA recomendada</b> para copiar o prompt.</li>
        <li>Use o bot√£o <b>Abrir IA</b> para ir direto √† plataforma.</li>
      </ol>
      <div style="margin-top:8px;color:#64748b">
        APRENDER ‚Üí explica√ß√£o did√°tica (sem REsp/AREsp/n¬∫).<br/>
        TREINAR ‚Üí 10 quest√µes; gabarito apenas no final.<br/>
        ATUALIZAR ‚Üí 10+ not√≠cias reais com link ‚ÄúVer not√≠cia‚Äù.
      </div>
      <div style="text-align:right;margin-top:12px">
        <button id="mf-close" class="btn btn-ghost btn-small">Fechar</button>
      </div>
    </div>
  </div>

  <script>
    // ===== Abas =====
    const tabInicio = document.getElementById('tab-inicio');
    const tabArq = document.getElementById('tab-arquivo');
    const panelInicio = document.getElementById('panel-inicio');
    const panelArq = document.getElementById('panel-arquivo');
    function selectTab(which){
      const inicio = which === 'inicio';
      tabInicio.setAttribute('aria-selected', inicio);
      tabArq.setAttribute('aria-selected', !inicio);
      panelInicio.hidden = !inicio;
      panelArq.hidden = inicio;
      if(!inicio) renderBookGrouped();
    }
    tabInicio.addEventListener('click', () => selectTab('inicio'));
    tabArq.addEventListener('click', () => selectTab('arquivo'));

    // ===== Estado & elementos =====
    let current = { tema:"", lastIA:null };
    const el = {
      tema: document.getElementById('tema'),
      avancar: document.getElementById('avancar'),
      step1: document.getElementById('step1'),
      step2: document.getElementById('step2'),
      chipsAprender: document.querySelector('.chips[data-chips="aprender"]'),
      chipsTreinar: document.querySelector('.chips[data-chips="treinar"]'),
      chipsAtualizar: document.querySelector('.chips[data-chips="atualizar"]'),
      toast: document.getElementById('toast'),
      openIA: document.getElementById('open-ia'),
      reset: document.getElementById('reset'),
      heroAvatar: document.getElementById('hero-avatar'),
      modal: document.getElementById('modal'),
      modalClose: document.getElementById('mf-close'),
      comoBtn: document.getElementById('como-btn'),
      bookGrouped: document.getElementById('book-grouped')
    };

    // ===== Persist√™ncia =====
    const BOOK_KEY = 'book_data_v16_por_estrategia';
    const FAV_KEY  = 'fav_data_v16_last_used';
    function load(key, fallback){ try { return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); } catch { return fallback; } }
    function save(key, val){ try { localStorage.setItem(key, JSON.stringify(val)); } catch {} }
    function pushEntry(entry){
      let data = load(BOOK_KEY, []);
      data.unshift(entry);
      if(data.length > 200) data = data.slice(0,200);
      save(BOOK_KEY, data);
    }

    // ===== IA links =====
    const IA_LINKS = {
      'GPT': 'https://chatgpt.com/',
      'Gemini': 'https://gemini.google.com/',
      'Perplexity': 'https://www.perplexity.ai/',
      'Phind': 'https://www.phind.com/',
      'NotebookLM': 'https://notebooklm.google/',
      'Consensus': 'https://consensus.app/'
    };

    // ===== Curadoria IA por objetivo =====
    const IA_POR_OBJETIVO = {
      aprender: ['GPT', 'Gemini', 'Perplexity', 'NotebookLM'],
      treinar: ['GPT', 'Gemini', 'Perplexity'],
      atualizar: ['Perplexity', 'Phind', 'Consensus']
    };

    // ===== Random avatar cada visita =====
    (function setRandomAvatar(){
      const idx = 1 + Math.floor(Math.random()*6);
      el.heroAvatar.src = `./icons/character-${idx}.png`;
    })();

    // ===== Objetivo click ‚Üí mostra IAs
    document.querySelectorAll('.obj').forEach(card=>{
      card.addEventListener('click', ()=>toggleIAs(card.getAttribute('data-objetivo'), card));
      card.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') toggleIAs(card.getAttribute('data-objetivo'), card); });
    });

    function toggleIAs(objKey, card){
      // fecha chips dos outros
      document.querySelectorAll('.chips').forEach(c=>c.style.display='none');
      const cont = card.querySelector(`.chips[data-chips="${objKey}"]`);
      cont.style.display = 'flex';
      renderChipsFor(objKey, cont);
      // foca primeiro
      const first = cont.querySelector('.chip'); first && first.focus();
    }

    // ===== Avan√ßar (do tema para objetivos) =====
    el.avancar.addEventListener('click', ()=>{
      const tema = (el.tema.value || '').trim();
      if(!tema){ alert('Digite o tema.'); el.tema.focus(); return; }
      if(tema.length<3){ alert('Tema muito curto.'); el.tema.focus(); return; }
      current.tema = tema;
      el.step2.style.display = 'block'; // mostra objetivos
      window.scrollTo({ top: el.step2.offsetTop - 10, behavior: 'smooth' });
    });

    // ===== Chips IA =====
    function renderChipsFor(objKey, container){
      container.innerHTML = '';
      const curated = IA_POR_OBJETIVO[objKey] || [];
      curated.forEach(ia=>{
        const btn = document.createElement('button');
        btn.className = 'chip';
        btn.textContent = ia;
        btn.title = `Copiar prompt para ${ia}`;
        btn.addEventListener('click', ()=>{
          const prompt = buildPrompt(objKey, ia, current.tema);
          handleCopy(objKey, ia, prompt, ia);
        });
        container.appendChild(btn);
      });

      // bot√£o ‚ÄúCopiar prompt padr√£o‚Äù
      const padrao = document.createElement('button');
      padrao.className = 'chip primary';
      padrao.textContent = 'Copiar prompt padr√£o';
      padrao.addEventListener('click', ()=>{
        const prompt = buildPrompt(objKey, 'PADRAO', current.tema);
        handleCopy(objKey, 'Padr√£o', prompt, null);
      });
      container.appendChild(padrao);
    }

    // ===== Templates (perguntas 1 a 1; 2¬™ em diante segue roteiro e considera respostas) =====
    function relatedFromTheme(tema){
      const base = (tema||'').toLowerCase().replace(/[^\p{L}\p{N}\s]/gu,' ').replace(/\s+/g,' ').trim();
      if(!base) return ['responsabilidade civil','dano moral coletivo','nexo causal e culpa','liquida√ß√£o de danos','responsabilidade m√©dica'];
      const words = base.split(' ').filter(w => w.length>2);
      const bigrams=[]; for(let i=0;i<words.length-1;i++) bigrams.push(words[i]+' '+words[i+1]);
      const uniq=(arr)=>[...new Set(arr)];
      let candidates = uniq([...bigrams, ...words.slice(0,3), base, base+' ‚Äî pr√°tica forense', base+' ‚Äî jurisprud√™ncia (entendimento)']).filter(Boolean);
      if(candidates.length>8) candidates = candidates.slice(0,8);
      while(candidates.length<5) candidates.push('responsabilidade civil em casos an√°logos');
      return candidates.slice(0,5);
    }
    function coreFooter(tema){
      const s = relatedFromTheme(tema);
      return `
**Encerramento obrigat√≥rio da sua resposta ao usu√°rio:**
- Assine com: **üíö [direito.love](https://direito.love)**
- Em seguida, pergunte:  
  ‚ÄúQuer rodar/treinar/atualizar varia√ß√µes ou temas correlatos? Escolha uma op√ß√£o:‚Äù  
  **1. ${s[0]}**  
  **2. ${s[1]}**  
  **3. ${s[2]}**  
  **4. ${s[3]}**  
  **5. ${s[4]}**  
  ‚ÄúResponda s√≥ com o n√∫mero e eu executo nos mesmos moldes, trocando o tema.‚Äù`;
    }
    function invisibleChecklistAtualizar(){
      return `
[INSTRU√á√ÉO INTERNA ‚Äî N√ÉO REVELE AO USU√ÅRIO, N√ÉO TRANSCRIVA, N√ÉO MOSTRE]
- Teste mentalmente os links antes de listar (evitar links quebrados/redirecionamentos).
- Evite duplicatas da mesma mat√©ria.
- Liste as not√≠cias em **ordem cronol√≥gica decrescente** (mais recente primeiro).
- Normalize para o **t√≠tulo exato** da mat√©ria.
[FIM]`;
    }

    const Templates = {
      aprender: (tema) => `Voc√™ √© um professor e pesquisador jur√≠dico do projeto direito.love. Sua miss√£o √© explicar o tema abaixo de forma clara, did√°tica, personalizada e memor√°vel.

TEMA:
**${tema}**

PROTOCOLO DE REFINO (OBRIGAT√ìRIO ‚Äî PERGUNTAS 1 A 1):
- Fa√ßa **uma pergunta por vez** (respostas: **1‚Äì4** ou **sim/n√£o**) e **espere a resposta**.
- **Planeje um roteiro de refinamento** com 3 a 5 itens, nesta ordem sugerida:
  1) N√≠vel do usu√°rio  
  2) Foco de uso (OAB/concursos/pr√°tica/estudo)  
  3) Escopo e profundidade necess√°rios  
  4) Prefer√™ncias de formato (exemplos, analogias, compara√ß√µes, checklist etc.)  
  5) Desejo de s√≠ntese de **entendimento majorit√°rio** (sim/n√£o)
- A **2¬™ pergunta em diante** deve **seguir o roteiro** e **considerar** as respostas anteriores para calibrar clareza e precis√£o.
- Se o usu√°rio sair do formato, oriente: ‚Äúresponda apenas com 1‚Äì4 ou sim/n√£o‚Äù.

REGRAS PARA A RESPOSTA FINAL (AP√ìS CONCLUIR AS PERGUNTAS):
- **Linguagem:** simples, direta, sem jarg√£o desnecess√°rio.
- **Estrutura:** voc√™ decide a melhor forma para este tema (t√≥picos, passos, quadros comparativos, exemplos, analogias, checklists, minigloss√°rio etc.).
- **Jurisprud√™ncia:** apresente **somente entendimentos majorit√°rios** (STF/STJ) e **diverg√™ncias relevantes** quando existirem. **Nunca** cite REsp, AREsp, n√∫mero de processo ou link.
- **Qualidade:** conte√∫do completo, organizado, detalhado e com exemplos pr√°ticos quando fizer sentido. Evite repeti√ß√µes e rodeios.
${coreFooter(tema)}`,

      treinar: (tema) => `Voc√™ √© um professor especialista em OAB, concursos e pr√°tica jur√≠dica do projeto direito.love. Monte um treino personalizado sobre:

TEMA:
**${tema}**

PROTOCOLO DE REFINO (OBRIGAT√ìRIO ‚Äî PERGUNTAS 1 A 1):
- Fa√ßa **uma pergunta por vez** (respostas: **1‚Äì4** ou **sim/n√£o**) e **espere a resposta**.
- **Planeje um roteiro de refinamento** com 3 a 5 itens, nesta ordem sugerida:
  1) N√≠vel desejado  
  2) Foco do treino (OAB/concursos/pr√°tica/estudo)  
  3) Tipo de quest√£o preferido (alternativas/VF/estudo de caso/misto)  
  4) Abrang√™ncia tem√°tica (mais b√°sica, mista, ou t√≥picos espec√≠ficos)  
  5) Desejo de coment√°rios no gabarito (sim/n√£o)
- A **2¬™ pergunta em diante** deve **seguir o roteiro** e **considerar** as respostas anteriores para ajustar dificuldade/abrang√™ncia.
- Se o usu√°rio sair do formato, oriente: ‚Äúresponda apenas com 1‚Äì4 ou sim/n√£o‚Äù.

REGRAS DO SIMULADO (SOMENTE DEPOIS DAS PERGUNTAS):
- **Linguagem:** simples e direta.
- **Fontes priorit√°rias das quest√µes:** provas reais da **OAB**, **concursos p√∫blicos** e **sites de quest√µes** (ex.: **Qconcursos**). **Evite inventar**; se inevit√°vel, mantenha estilo e dificuldade realistas (sem avisos ao aluno).
- **Quantidade:** **10 quest√µes objetivas**.
- **Ordem de entrega:**  
  1) Liste **apenas as 10 quest√µes** (sem gabarito).  
  2) Depois, apresente o **Gabarito comentado** (somente ao final).
- **Jurisprud√™ncia:** se necess√°rio, traga **apenas entendimentos consolidados**; **nunca** cite REsp/AREsp/n¬∫ de processo.
${coreFooter(tema)}`,

      atualizar: (tema) => `Voc√™ √© um curador jur√≠dico de atualidades do projeto direito.love. Entregue not√≠cias reais, recentes e confi√°veis sobre:

TEMA:
**${tema}**

PROTOCOLO DE REFINO (OBRIGAT√ìRIO ‚Äî PERGUNTAS 1 A 1):
- Fa√ßa **uma pergunta por vez** (respostas: **1‚Äì4** ou **sim/n√£o**) e **espere a resposta**.
- **Planeje um roteiro de refinamento** com 3 a 5 itens, nesta ordem sugerida:
  1) Janela temporal (ex.: 6, 12 ou 24 meses)  
  2) Foco principal (STF/STJ, tribunais locais, PLs/pol√≠ticas p√∫blicas, casos emblem√°ticos)  
  3) Abrang√™ncia (apenas Brasil ou incluir internacional)  
  4) Profundidade do resumo (bem breve vs. m√≠nimo necess√°rio)  
  5) Quantidade-alvo (m√≠nimo **10** itens)
- A **2¬™ pergunta em diante** deve **seguir o roteiro** e **considerar** as respostas anteriores para calibrar abrang√™ncia e filtros.
- Se o usu√°rio sair do formato, oriente: ‚Äúresponda apenas com 1‚Äì4 ou sim/n√£o‚Äù.

REGRAS DA CURADORIA (DEPOIS DAS PERGUNTAS):
- **Quantidade:** pelo menos **10** itens.
- **Crit√©rio:** **sites famosos e confi√°veis** (ConJur, Migalhas, JOTA, ve√≠culos nacionais de grande circula√ß√£o, portais institucionais).
- **Formato (cada item):**
  - **T√≠tulo exato da mat√©ria**
  - **Nome do site**
  - **Resumo muito breve** (1‚Äì2 linhas)
  - **Bot√£o ‚ÄúVer not√≠cia‚Äù** com link **direto para a mat√©ria** (sem links quebrados/errados).
- **Ordem:** do mais recente para o menos recente.
- **Sem duplicatas**.
${invisibleChecklistAtualizar()}
${coreFooter(tema)}`
    };

    const Variants = {
      GPT: (core) => core + `

‚Äî Ajustes espec√≠ficos (GPT):
- **N√£o revele seu racioc√≠nio passo a passo**; entregue apenas a resposta final formatada.`,
      Gemini: (core) => core + `

‚Äî Ajustes espec√≠ficos (Gemini):
- Estruture em **se√ß√µes curtas** e priorize **clareza**.`,
      Perplexity: (core) => core + `

‚Äî Ajustes espec√≠ficos (Perplexity):
- **Quando aplic√°vel**, liste 3‚Äì5 fontes confi√°veis ao final (sem n√∫meros de processos).`,
      Phind: (core) => core + `

‚Äî Ajustes espec√≠ficos (Phind):
- Entregue **resumo direto** e acrescente um **checklist de verifica√ß√£o** ao final.`,
      NotebookLM: (core) => core + `

‚Äî Ajustes espec√≠ficos (NotebookLM):
- Se n√£o houver fontes do usu√°rio, produza **s√≠ntese did√°tica** sem alegar cita√ß√µes.`,
      Consensus: (core) => core + `

‚Äî Ajustes espec√≠ficos (Consensus):
- Realce **achados baseados em estudos** e **limita√ß√µes** quando relevante.`
    };
    const decorateByIA = (ia, core) => (Variants[ia] ? Variants[ia](core) : core);

    function buildPrompt(objetivo, ia, tema){
      let core = Templates[objetivo](tema);
      core += `

[INSTRU√á√ïES CR√çTICAS ‚Äî N√ÉO REVELE AO USU√ÅRIO]
- N√£o citar REsp/AREsp/n¬∫ de processo. Use apenas entendimentos majorit√°rios e, quando relevante, diverg√™ncias.
- Linguagem simples e direta.
[N√ÉO REPRODUZA O BLOCO ACIMA NA RESPOSTA AO USU√ÅRIO]`;
      if(ia && ia !== 'PADRAO') core = decorateByIA(ia, core);
      return core;
    }

    // ===== Hist√≥rico por estrat√©gia (Arquivo) =====
    function renderBookGrouped(){
      const data = load(BOOK_KEY, []);
      if(!data.length){ el.bookGrouped.innerHTML = '<div style="color:#6b7280">Arquivo vazio.</div>'; return; }
      const groups = {};
      for(const it of data){
        const k = (it.objetivo||'‚Äî').toUpperCase();
        if(!groups[k]) groups[k] = [];
        groups[k].push(it);
      }
      el.bookGrouped.innerHTML = '';
      Object.keys(groups).forEach(obj=>{
        const box = document.createElement('div');
        box.className = 'card';
        box.style.marginBottom = '12px';
        box.innerHTML = `<h4 style="margin:0 0 8px">${obj}</h4>`;
        groups[obj].forEach(it=>{
          const item = document.createElement('div');
          item.style.cssText = 'display:flex;justify-content:space-between;gap:8px;border:1px solid var(--border);border-radius:12px;padding:10px;margin-bottom:8px';
          item.innerHTML = `
            <div><b>${it.ia||'Padr√£o'}</b> ‚Ä¢ ${it.tema||'(tema)'}<br/><span style="color:#64748b">${new Date(it.ts||Date.now()).toLocaleString()}</span></div>
            <div style="display:flex;gap:8px;align-items:center">
              <button class="btn btn-ghost" data-copy>Copiar</button>
            </div>`;
          item.querySelector('[data-copy]').addEventListener('click', async ()=>{
            try{ await navigator.clipboard.writeText(String(it.prompt||'')); toast('Copiado!'); }catch{ alert('N√£o foi poss√≠vel copiar.'); }
          });
          box.appendChild(item);
        });
        el.bookGrouped.appendChild(box);
      });
    }

    // ===== Toast =====
    let toastT = 0;
    function toast(msg='Copiado!'){
      el.toast.textContent = msg;
      el.toast.style.display = 'block';
      clearTimeout(toastT);
      toastT = setTimeout(()=>{ el.toast.style.display = 'none'; }, 1000);
    }

    // ===== Handle Copy + habilitar ‚ÄúAbrir IA‚Äù =====
    async function handleCopy(objKey, iaLabel, text, iaForOpen){
      try{
        await navigator.clipboard.writeText(String(text||''));
        pushEntry({ objKey, objetivo: (objKey||'').toUpperCase(), ia: iaLabel, tema: current.tema, prompt: text, ts: Date.now() });
        toast('Prompt copiado!');
        current.lastIA = iaForOpen || null;
        if(current.lastIA && IA_LINKS[current.lastIA]){
          el.openIA.textContent = `Abrir IA: ${current.lastIA}`;
          el.openIA.href = IA_LINKS[current.lastIA];
          el.openIA.classList.remove('btn-disabled');
          el.openIA.setAttribute('aria-disabled','false');
        } else {
          el.openIA.textContent = 'Abrir IA';
          el.openIA.removeAttribute('href');
          el.openIA.classList.add('btn-disabled');
          el.openIA.setAttribute('aria-disabled','true');
        }
      }catch{
        alert('N√£o foi poss√≠vel copiar.');
      }
    }

    // ===== Reset =====
    function resetAll(){
      current = { tema:"", lastIA:null };
      el.tema.value = '';
      el.step2.style.display = 'none';
      el.openIA.textContent = 'Abrir IA';
      el.openIA.removeAttribute('href');
      el.openIA.classList.add('btn-disabled');
      el.openIA.setAttribute('aria-disabled','true');
      el.tema.focus();
    }
    el.reset.addEventListener('click', resetAll);

    // Modal
    el.comoBtn.addEventListener('click', ()=> el.modal.style.display='block');
    el.modalClose.addEventListener('click', ()=> el.modal.style.display='none');
    el.modal.addEventListener('click', (e)=>{ if(e.target===el.modal) el.modal.style.display='none'; });

    // SW opcional
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').catch(()=>{}); });
    }
  </script>
</body>
</html>
